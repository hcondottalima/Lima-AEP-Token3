<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audience Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset Básico e Variáveis de Cor */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --color-primary: #02455C;
            --color-accent: #F98509;
            --color-text: #231F20;
            --color-background: #f7f8fa;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
        }

        body,
        html {
            height: 100%;
            font-family: 'Inter', Arial, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .main-content {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .panel {
            height: 100%;
            overflow-y: auto;
        }

        .left-panel {
            width: 40%;
            max-width: 480px;
            min-width: 320px;
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex-grow: 1;
            padding: 1.5rem;
        }
        
        h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        p { color: #555; }

        /* Estilos dos Componentes */
        .card {
            background-color: var(--color-surface);
            border-radius: 8px;
            border: 1px solid var(--color-border);
            margin-bottom: 20px;
        }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { font-size: 0.875rem; font-weight: 500; color: #555; margin-bottom: 4px; display: block; }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            background-color: var(--color-surface);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(2, 69, 92, 0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--color-accent);
            color: white;
        }
        .btn-primary:hover { background-color: #e07508; }

        .btn-secondary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-secondary:hover { background-color: #013446; }

        /* Styles for the JSON tree view */
        #tree-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .tree ul {
            padding-left: 1rem;
            border-left: 1px solid var(--color-border);
        }
        .tree li {
            position: relative;
            list-style: none;
            padding: 2px 0;
        }
        .tree .tree-node {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .tree .tree-node:hover {
            background-color: #f0f2f5;
        }
        .tree .tree-node.selected {
            background-color: var(--color-primary);
            color: white;
        }
        .tree .tree-node.selected .key {
            color: white;
        }
        .key {
            color: var(--color-accent);
            font-weight: 600;
        }

        /* JSON viewer styles */
        .json-viewer {
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            padding: 1.5rem;
        }
        .json-viewer .string { color: #0c9d58; }
        .json-viewer .number { color: #4285f4; }
        .json-viewer .boolean { color: #9c27b0; }
        .json-viewer .null { color: #9e9e9e; }
        .json-viewer .key { color: var(--color-accent); font-weight: 600; }
        .json-viewer a { color: #4285f4; text-decoration: none; }
        .json-viewer a:hover { text-decoration: underline; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F7F8FA; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>

<body>
    <div id="app" class="app-container">
        <div class="main-content">
            <!-- Left Panel -->
            <aside class="panel left-panel">
                <header>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h1>Audience Explorer</h1>
                        <button id="exportButton" class="btn btn-primary">
                            <i class="fas fa-file-csv"></i>
                            <span>Export CSV</span>
                        </button>
                    </div>
                    <p style="margin-bottom: 1.5rem;">Browse and filter your audience segments.</p>
                </header>

                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="flex-grow: 1;">
                        <input type="text" id="filterInput" placeholder="Filter..." class="form-input">
                    </div>
                    <div>
                        <select id="filterFieldSelect" class="form-select">
                            <option value="all" selected>All Fields</option>
                            <option value="name">Name</option>
                            <option value="id">ID</option>
                            <option value="description">Description</option>
                            <option value="attributes">Attributes</option>
                            <option value="events">Events</option>
                            <option value="segmentType">Segment Type</option>
                            <option value="lifecycleState">Lifecycle State</option>
                            <option value="totalProfiles">Total Profiles</option>
                        </select>
                    </div>
                </div>

                <div id="stats" style="font-size: 0.8rem; color: #555; margin-bottom: 0.5rem;">Loading data...</div>

                <div id="tree-container">
                    <div id="loader" style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 1rem;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--color-primary);"></i>
                        <span style="color: #555;">Loading audiences...</span>
                    </div>
                </div>
                 <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                    <label for="debugToggle" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #555; cursor: pointer;">
                        <input id="debugToggle" type="checkbox" class="form-checkbox">
                        <span>Debug Mode</span>
                    </label>
                </div>
            </aside>

            <!-- Right Panel -->
            <main class="panel right-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Object Details</h2>
                    <button id="summarizeButton" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>Summarize with AI</span>
                    </button>
                </div>
                <div id="details-container" class="card json-viewer">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <p>Select an object from the list to see its details.</p>
                    </div>
                </div>
                <div id="summary-container" class="card" style="display: none; margin-top: 1.5rem;">
                    <h3><i class="fas fa-book-sparkles" style="margin-right: 0.5rem;"></i>AI Summary</h3>
                    <div id="summary-content" style="padding-top: 1rem;"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                fullData: [],
                filteredData: [],
                selectedNode: null,
                debug: false,
            };

            const filterInput = document.getElementById('filterInput');
            const filterFieldSelect = document.getElementById('filterFieldSelect');
            const treeContainer = document.getElementById('tree-container');
            const detailsContainer = document.getElementById('details-container');
            const statsElement = document.getElementById('stats');
            const loader = document.getElementById('loader');
            const summarizeButton = document.getElementById('summarizeButton');
            const summaryContainer = document.getElementById('summary-container');
            const summaryContent = document.getElementById('summary-content');
            const exportButton = document.getElementById('exportButton');
            const debugToggle = document.getElementById('debugToggle');
            let currentSegmentForSummary = null;

            const callGeminiApi = async (prompt) => {
                // This function is a placeholder for the actual Gemini API call.
                // In a real scenario, this would be handled by the backend or a secure environment.
                console.log("Calling Gemini API with prompt:", prompt);
                await new Promise(res => setTimeout(res, 1500)); // Simulate network delay
                return `This is a simulated AI summary for the segment. Based on the data, this audience appears to target **high-value customers** who have made recent purchases. Key attributes include:
*   **Status:** Active
*   **Location:** North America
*   **Interest:** Tech Gadgets`;
            };

            const getFilteredSegmentForSummary = (segment) => {
                if (state.debug) {
                    return segment;
                }
                const newSegment = { ...segment };
                delete newSegment.dependents;
                delete newSegment.dependencies;
                return newSegment;
            };

            const handleSummarizeClick = async () => {
                if (!currentSegmentForSummary) {
                    console.error("No segment selected for summary.");
                    return;
                }

                summaryContainer.style.display = 'block';
                summaryContent.innerHTML = '<div style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Generating summary...</div>';

                const systemInstruction = "You are an expert marketing data analyst. Your task is to provide a clear, concise, and business-focused summary of a user audience segment based on its JSON definition. Explain who is in this audience in simple terms. Ignore technical details like IDs, hashes, and timestamps unless they are critical for understanding the segment. Focus on the 'name', 'description', and 'expression' fields to deduce the audience's purpose.";
                const filteredSegment = getFilteredSegmentForSummary(currentSegmentForSummary);
                const userQuery = `Please summarize the following audience segment JSON:\n\n\
```json\
${JSON.stringify(filteredSegment, null, 2)}\
```\
`;
                const fullPrompt = `${systemInstruction}\n\n${userQuery}`;

                const summaryText = await callGeminiApi(fullPrompt);

                let formattedHtml = summaryText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^\* (.*$)/gim, '<li style="margin-left: 1.5rem; list-style: disc;">$1</li>')
                    .replace(/\n/g, '<br>');

                summaryContent.innerHTML = formattedHtml;
            };

            function transformAudienceData(data) {
                if (!data || !Array.isArray(data.segments)) {
                    console.error("Invalid data format: 'segments' array not found.");
                    return [];
                }
                return data.segments.map(segment => {
                    const result = {
                        name: segment.name,
                        id: segment.id,
                        description: segment.description,
                        lifecycleState: segment.lifecycleState,
                        dependents: segment.dependents,
                        dependencies: segment.dependencies,
                        totalProfiles: segment.metrics?.data?.totalProfiles ?? null,
                        creationDate: new Date(segment.creationTime).toLocaleString()
                    };
                    const evalInfo = segment.evaluationInfo;
                    if (evalInfo?.batch?.enabled) result.segmentType = "Batch";
                    else if (evalInfo?.continuous?.enabled) result.segmentType = "Streaming";
                    else if (evalInfo?.synchronous?.enabled) result.segmentType = "Edge";
                    else result.segmentType = null;

                    const attributes = segment.ansibleDataModel?.dataModel?.expression?.profileAttributesContainer?.items
                        ?.map(item => item?.component?.id?.replace(/^profile\./, ''))
                        .filter(id => id != null && id !== 'segmentMembership.segmentID._id') || [];
                    if (attributes.length > 0) result.attributes = attributes;

                    const events = segment.ansibleDataModel?.dataModel?.expression?.xEventAttributesContainer?.items
                        ?.flatMap(outerItem => outerItem?.items || [])
                        ?.map(componentItem => componentItem?.eventType?.id?.replace(/^xEvent\./, ''))
                        .filter(id => id != null) || [];
                    if (events.length > 0) result.events = events;

                    return result;
                });
            }

            const loadAllData = async () => {
                // This is a placeholder for the data loading logic.
                // In a real application, you would fetch this from a server or an API.
                try {
                    // Simulating a fetch call for local JSON data
                    const response = await fetch('../jornadas/audiences_page0.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return transformAudienceData(data);
                } catch (error) {
                    console.error('Error loading audience data:', error);
                    statsElement.innerHTML = `<span style="color: #d9534f;">Error loading data.</span>`;
                    return [];
                }
            };

            const createTreeNode = (key) => {
                const li = document.createElement('li');
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                const keySpan = document.createElement('span');
                keySpan.className = 'key';
                keySpan.textContent = key;
                nodeDiv.appendChild(keySpan);
                li.appendChild(nodeDiv);
                return { li, nodeDiv };
            };

            const renderTree = (data, parent) => {
                parent.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'tree';
                data.forEach((item, index) => {
                    const name = item.name || `Segment ${index}`;
                    const { li, nodeDiv } = createTreeNode(name);
                    nodeDiv.dataset.id = item.id;
                    ul.appendChild(li);
                });
                parent.appendChild(ul);
            };

            const renderDetails = (data) => {
                if (!data) {
                    detailsContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;"><p>Select an object from the list to see its details.</p></div>';
                    summarizeButton.style.display = 'none';
                    summaryContainer.style.display = 'none';
                    currentSegmentForSummary = null;
                    return;
                }

                const valueToHtml = (value) => {
                    if (value === null) return `<span class="null">null</span>`;
                    switch (typeof value) {
                        case 'string': return `"<span class="string">${value}</span>"`;
                        case 'number': return `<span class="number">${value}</span>`;
                        case 'boolean': return `<span class="boolean">${value}</span>`;
                        case 'object':
                            if (Array.isArray(value)) {
                                if (value.length === 0) return '[]';
                                let arrHtml = '[\n';
                                arrHtml += value.map(item => `&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"${item}"</span>`).join(',\n');
                                arrHtml += `\n&nbsp;&nbsp;]`;
                                return arrHtml;
                            }
                            return JSON.stringify(value, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
                        default: return String(value);
                    }
                };

                let html = '{<br>';
                const keys = Object.keys(data);
                keys.forEach((key, index) => {
                    const value = data[key];
                    const isLast = index === keys.length - 1;
                    html += `&nbsp;&nbsp;<span class="key">"${key}"</span>: `;

                    if (key === 'id' && typeof value === 'string') {
                        const url = `https://experience.adobe.com/#/@xpi/sname:prod/platform/segment/browse/${value}`;
                        html += `<a href="${url}" target="_blank">"<span class="string">${value}</span>"</a>`;
                    } else if ((key === 'dependents' || key === 'dependencies') && Array.isArray(value) && value.length > 0) {
                        let arrHtml = '[\n';
                        arrHtml += value.map(id => {
                            const depSegment = state.fullData.find(s => s.id === id);
                            const depName = depSegment ? depSegment.name : id;
                            return `&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" class="dependency-link" data-id="${id}" title="Click to view segment: ${id}">"<span class="string">${depName}</span>"</a>`;
                        }).join(',\n');
                        arrHtml += `\n&nbsp;&nbsp;]`;
                        html += arrHtml;
                    } else {
                        html += valueToHtml(value);
                    }
                    html += `${isLast ? '' : ','}<br>`;
                });
                html += '}';
                detailsContainer.innerHTML = html;

                detailsContainer.querySelectorAll('.dependency-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.dataset.id;
                        const isTargetInFilteredList = state.filteredData.some(item => item.id === targetId);
                        if (!isTargetInFilteredList) {
                            filterInput.value = '';
                            filterFieldSelect.value = 'all';
                            handleFilter();
                        }
                        setTimeout(() => {
                            const targetNode = treeContainer.querySelector(`.tree-node[data-id="${targetId}"]`);
                            if (targetNode) {
                                targetNode.click();
                                targetNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 50);
                    });
                });

                summarizeButton.style.display = 'inline-flex';
                summaryContainer.style.display = 'none';
                summaryContent.innerHTML = '';
                currentSegmentForSummary = data;
            };

            const handleFilter = () => {
                const query = filterInput.value.toLowerCase().trim();
                const filterField = filterFieldSelect.value;

                state.filteredData = !query ? state.fullData : state.fullData.filter(item => {
                    if (filterField === 'all') {
                        return Object.values(item).some(val => 
                            String(val).toLowerCase().includes(query)
                        );
                    }
                    const value = item[filterField];
                    return value ? String(value).toLowerCase().includes(query) : false;
                });

                statsElement.textContent = `Showing ${state.filteredData.length} of ${state.fullData.length} segments.`;
                renderTree(state.filteredData, treeContainer);
                renderDetails(null);
                if (state.selectedNode) {
                    state.selectedNode.classList.remove('selected');
                    state.selectedNode = null;
                }
            };
            
            const exportToCsv = () => {
                if (state.filteredData.length === 0) return;
                const headers = ['Name', 'ID', 'TotalProfiles', 'CreationDate', 'Description'];
                const csvRows = [headers.join(',')];
                const escapeCsvCell = (cell) => {
                    if (cell == null) return '';
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                };
                state.filteredData.forEach(item => {
                    const row = headers.map(header => escapeCsvCell(item[header.toLowerCase()]));
                    csvRows.push(row.join(','));
                });
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'filtered_audiences.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            treeContainer.addEventListener('click', (e) => {
                const nodeDiv = e.target.closest('.tree-node');
                if (!nodeDiv) return;
                if (state.selectedNode) {
                    state.selectedNode.classList.remove('selected');
                }
                nodeDiv.classList.add('selected');
                state.selectedNode = nodeDiv;
                const id = nodeDiv.dataset.id;
                if (id) {
                    const selectedItem = state.filteredData.find(item => item.id === id);
                    renderDetails(selectedItem);
                }
            });

            const init = async () => {
                state.fullData = await loadAllData();
                state.filteredData = state.fullData;
                loader.style.display = 'none';
                statsElement.textContent = `Loaded ${state.fullData.length} total segments.`;
                renderTree(state.filteredData, treeContainer);
                filterInput.addEventListener('keyup', handleFilter);
                filterFieldSelect.addEventListener('change', handleFilter);
                summarizeButton.addEventListener('click', handleSummarizeClick);
                exportButton.addEventListener('click', exportToCsv);
                debugToggle.addEventListener('change', (e) => {
                    state.debug = e.target.checked;
                });
            };
            init();
        });
    </script>
</body>

</html>